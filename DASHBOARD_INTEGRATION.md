# Dashboard Integration Guide

## Overview

Your infrastructure is configured to **automatically deploy your dashboard** to S3 whenever you run `terraform apply`. The dashboard files are uploaded from the `dashboard/` directory.

## S3 Bucket Structure

After deployment, your S3 bucket will have this structure:

```
s3://your-bucket-name/
├── dashboard/
│   ├── index.html       ← Your main dashboard page
│   ├── styles.css       ← Your CSS styles
│   └── scripts.js       ← Your JavaScript code
└── reports/
    ├── daily/
    │   └── daily.json   ← Auto-generated by collector Lambda
    └── weekly/
        └── YYYY-Www.csv ← Auto-generated by weekly report Lambda
```

## How to Deploy Your Dashboard

### Step 1: Add Your Dashboard Files

Replace the placeholder files in the `dashboard/` directory with your actual files:

```bash
cd dashboard/

# Remove placeholder files (optional)
rm index.html styles.css scripts.js

# Copy your actual dashboard files
cp /path/to/your/index.html .
cp /path/to/your/styles.css .
cp /path/to/your/scripts.js .
```

### Step 2: Deploy with Terraform

```bash
cd ../infra
terraform apply
```

Terraform will automatically:
1. Upload all files from `dashboard/` to `s3://bucket/dashboard/`
2. Set correct MIME types (HTML, CSS, JS)
3. Create the reports folder structure

### Step 3: Access Your Dashboard

After deployment, get your dashboard URL:

```bash
terraform output s3_website_endpoint
```

Your dashboard will be available at:
```
http://your-bucket.s3-website-us-west-2.amazonaws.com/dashboard/index.html
```

## Fetching Cost Data in Your Dashboard

Your dashboard can fetch cost reports using relative URLs:

### Daily Report (JSON)

```javascript
async function loadDailyCosts() {
    const response = await fetch('/reports/daily/daily.json');
    const data = await response.json();
    
    // Process Cost Explorer data
    const results = data.ResultsByTime[0];
    const groups = results.Groups;
    
    // Display costs by service
    groups.forEach(group => {
        const service = group.Keys[0];
        const cost = parseFloat(group.Metrics.UnblendedCost.Amount);
        console.log(`${service}: $${cost.toFixed(2)}`);
    });
}
```

### Weekly Reports (CSV)

```javascript
async function loadWeeklyReport(weekNumber) {
    // Example: 2025-W01.csv
    const filename = `2025-W${weekNumber.toString().padStart(2, '0')}.csv`;
    const response = await fetch(`/reports/weekly/${filename}`);
    const csvText = await response.text();
    
    // Parse CSV
    const lines = csvText.split('\n');
    const headers = lines[0].split(',');
    // Process data...
}
```

## CORS Configuration (If Needed)

If you're accessing the dashboard from a different domain, you may need to add CORS configuration to the S3 module.

Edit `infra/modules/s3/main.tf` and add:

```hcl
resource "aws_s3_bucket_cors_configuration" "reports" {
  bucket = aws_s3_bucket.reports.id

  cors_rule {
    allowed_headers = ["*"]
    allowed_methods = ["GET", "HEAD"]
    allowed_origins = ["*"]
    expose_headers  = ["ETag"]
    max_age_seconds = 3000
  }
}
```

## Automatic Updates

Whenever you update your dashboard files:

1. Edit files in `dashboard/` directory
2. Run `terraform apply`
3. Terraform detects changes (via file hash) and re-uploads

## Adding More Files

You can add any files to the `dashboard/` directory:

- Images: `logo.png`, `chart-icon.svg`
- Additional CSS: `components.css`, `responsive.css`
- Additional JS: `charts.js`, `api.js`
- Fonts, icons, etc.

All files will be automatically uploaded with correct MIME types.

## Supported File Types

The S3 module automatically sets MIME types for:

- `.html` → `text/html`
- `.css` → `text/css`
- `.js` → `application/javascript`
- `.json` → `application/json`
- `.png`, `.jpg`, `.gif`, `.svg` → image types
- `.ico` → `image/x-icon`

## Example: Using Chart.js

If your dashboard uses Chart.js or other libraries:

```html
<!-- In your index.html -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="scripts.js"></script>
```

```javascript
// In your scripts.js
async function renderCostChart() {
    const data = await fetch('/reports/daily/daily.json').then(r => r.json());
    
    const services = [];
    const costs = [];
    
    data.ResultsByTime[0].Groups.forEach(group => {
        services.push(group.Keys[0]);
        costs.push(parseFloat(group.Metrics.UnblendedCost.Amount));
    });
    
    new Chart(document.getElementById('costChart'), {
        type: 'bar',
        data: {
            labels: services,
            datasets: [{
                label: 'Daily Cost (USD)',
                data: costs,
                backgroundColor: 'rgba(102, 126, 234, 0.5)'
            }]
        }
    });
}
```

## Troubleshooting

### Dashboard not updating?

1. Check file hash: Terraform uses MD5 hash to detect changes
2. Force update: `terraform taint 'module.s3.aws_s3_object.dashboard_files["index.html"]'`
3. Then run: `terraform apply`

### 404 errors?

1. Verify files exist: `ls -la dashboard/`
2. Check S3: `aws s3 ls s3://your-bucket/dashboard/`
3. Verify website hosting is enabled

### CORS errors?

Add CORS configuration (see above section)

## Next Steps

1. Replace placeholder dashboard files with your actual files
2. Test locally before deploying
3. Run `terraform apply` to deploy
4. Access your dashboard via the S3 website endpoint
5. Monitor Lambda logs to ensure reports are being generated
